"use strict";(self.webpackChunk_1_inch_docs=self.webpackChunk_1_inch_docs||[]).push([[1824],{3905:function(e,t,n){n.d(t,{Zo:function(){return u},kt:function(){return p}});var r=n(67294);function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){l(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,l=function(e,t){if(null==e)return{};var n,r,l={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(l[n]=e[n]);return l}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(l[n]=e[n])}return l}var o=r.createContext({}),d=function(e){var t=r.useContext(o),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=d(e.components);return r.createElement(o.Provider,{value:t},e.children)},k={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},c=r.forwardRef((function(e,t){var n=e.components,l=e.mdxType,a=e.originalType,o=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),c=d(n),p=l,h=c["".concat(o,".").concat(p)]||c[p]||k[p]||a;return n?r.createElement(h,i(i({ref:t},u),{},{components:n})):r.createElement(h,i({ref:t},u))}));function p(e,t){var n=arguments,l=t&&t.mdxType;if("string"==typeof e||l){var a=n.length,i=new Array(a);i[0]=c;var s={};for(var o in t)hasOwnProperty.call(t,o)&&(s[o]=t[o]);s.originalType=e,s.mdxType="string"==typeof e?e:l,i[1]=s;for(var d=2;d<a;d++)i[d]=n[d];return r.createElement.apply(null,i)}return r.createElement.apply(null,n)}c.displayName="MDXCreateElement"},25304:function(e,t,n){n.r(t),n.d(t,{frontMatter:function(){return s},contentTitle:function(){return o},metadata:function(){return d},toc:function(){return u},default:function(){return c}});var r=n(87462),l=n(63366),a=(n(67294),n(3905)),i=["components"],s={sidebar_position:3},o="Staking",d={unversionedId:"fusion-swap/staking-and-staking-power",id:"fusion-swap/staking-and-staking-power",isDocsHomePage:!1,title:"Staking",description:"Staking and staking power",source:"@site/docs/fusion-swap/staking-and-staking-power.mdx",sourceDirName:"fusion-swap",slug:"/fusion-swap/staking-and-staking-power",permalink:"/docs/fusion-swap/staking-and-staking-power",editUrl:"https://github.com/1inch/1inch-docs/edit/master/docs/fusion-swap/staking-and-staking-power.mdx",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"tutorialSidebar",previous:{title:"How to become a resolver",permalink:"/docs/fusion-swap/how-to-become-resolver"},next:{title:"Wallet auto-connect",permalink:"/docs/wallet-auto-connect"}},u=[{value:"Staking and staking power",id:"staking-and-staking-power",children:[]},{value:"Delegation",id:"delegation",children:[]},{value:"Farmings",id:"farmings",children:[]},{value:"Register as a resolver",id:"register-as-a-resolver",children:[]},{value:"Fee bank",id:"fee-bank",children:[]},{value:"Resolving",id:"resolving",children:[]},{value:"Setup script example",id:"setup-script-example",children:[{value:"1. Stake 1inch",id:"1-stake-1inch",children:[]},{value:"2. Register as a Resolver",id:"2-register-as-a-resolver",children:[]},{value:"3. FeeBank",id:"3-feebank",children:[]},{value:"Resolving",id:"resolving-1",children:[]}]}],k={toc:u};function c(e){var t=e.components,n=(0,l.Z)(e,i);return(0,a.kt)("wrapper",(0,r.Z)({},k,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"staking"},"Staking"),(0,a.kt)("h2",{id:"staking-and-staking-power"},"Staking and staking power"),(0,a.kt)("p",null,"The whitelisted top-5 stakers are determined by the staking power. Stakers can lock 1inch tokens in the staking contract to get st1inch tokens. The lock period is between 1 day and 4 years. st1inch tokens grants a staker \u201cstaking power.\u201d The longer the locking period the more \u201cstaking power\u201d a resolver gets. However, the increase in power is not linear:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"2-years lock will give the staker 1 \u201cstaking power\u201d for each 1inch"),(0,a.kt)("li",{parentName:"ul"},"1.5-years lock will give the staker 0.47 \u201cstaking power\u201d for each 1inch"),(0,a.kt)("li",{parentName:"ul"},"1-years lock will give the staker 0.22 \u201cstaking power\u201d for each 1inch"),(0,a.kt)("li",{parentName:"ul"},"0.5-year lock will give the staker 0.1 \u201cstaking power\u201d for each 1inch"),(0,a.kt)("li",{parentName:"ul"},"Expired lock will give the staker only 0.05 \u201cstaking power\u201d for each 1inch")),(0,a.kt)("img",{src:"/img/fusion/staking-image.png",alt:"staking-image"}),(0,a.kt)("h2",{id:"delegation"},"Delegation"),(0,a.kt)("p",null,"To help overcome the entry barrier to get into the whitelist a resolver can engage 1inch stakers to delegate their \u201cstaking power\u201d to him."),(0,a.kt)("p",null,"When a staker delegates his \u201cstaking power\u201d to a resolver, his power is added to the resolver\u2019s \u201cstaking power\u201d and helps him to enter and remain in the whitelist. Delegated \u201cstaking power\u201d is decreased over time with a lock period in the same manner as a resolver\u2019s \u201cstaking power\u201d."),(0,a.kt)("p",null,"A staker can delegate all its power to a single resolver at one moment of time."),(0,a.kt)("h2",{id:"farmings"},"Farmings"),(0,a.kt)("p",null,"To incentivize stakers to delegate their voting power Fusion infrastructure creates a default farm for each resolver and any staker delegated his \u201cstaking power\u201d to a resolver is automatically joined the farm. The resolver who owns the farm may provide rewards for joined delegates which are distributed to them proportionally to the delegated \u201cstaking power\u201d and time spent delegating."),(0,a.kt)("h2",{id:"register-as-a-resolver"},"Register as a resolver"),(0,a.kt)("p",null,"It is not enough to have sufficient \u201cstaking power\u201d but a Resolver should also be enlisted as a resolver which involves two actions: 1) register a delegation pod and 2) register for whitelisting. Optionally, a resolver may define the default farm that a delegating staker will automatically join after delegation."),(0,a.kt)("p",null,"If a resolver wants to fill orders from another address then that is whitelisted then he should define a worker address for this purpose. Otherwise, if a resolver wants to fill orders from its own address he should register his own address as a worker."),(0,a.kt)("p",null,"The whitelist contains top-5 resolvers by staking power. The position in the list defines the access priority for resolving. The Dutch auction duration is split equally into 6 intervals."),(0,a.kt)("p",null,"For example, if Dutch auction is lasted 6 minutes, then 1st minute the top-1 resolver is allowed to fill the order, on the 2nd minute top-1 and top-2 resolvers are allowed to fill the order and so on. On the 5th minute all the resolvers from the whitelist are allowed to fill the order. On the 5th minute the order becomes public and all the resolvers despite of the whitelist are allowed to fill it."),(0,a.kt)("p",null,"Below is an example of 7 minutes long auction"),(0,a.kt)("img",{src:"/img/fusion/auction.png",alt:"auction-image"}),(0,a.kt)("h2",{id:"fee-bank"},"Fee bank"),(0,a.kt)("p",null,"For each order filled, a resolver should pay a fee. This fee is automatically substructed from a resolver\u2019s account at the fee bank. Order fill will be reverted if there is not enough account balance at the fee bank. So a resolver should deposit enough 1inch tokens to fill orders."),(0,a.kt)("p",null,"If a worker is defined for filling orders then a deposit should be made to this worker account at the FeeBank."),(0,a.kt)("h2",{id:"resolving"},"Resolving"),(0,a.kt)("p",null,"If all the previously described requirements are met and steps are done, then a resolver may start filling orders by calling resolve method of the settlement contract. If a resolver wants to fill several orders in one transaction then he should add taker\u2019s interactions with chain order fill in it. See limit orders documentation for details."),(0,a.kt)("h2",{id:"setup-script-example"},"Setup script example"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"// Ethers setup script\n\n// approve 1inch staking\nawait (await inch.connect(resolver).approve(st1inch.address, stakeAmount));\n// stake 1inch token\nawait (await st1inch.connect(resolver).deposit(stakeAmount, lockTime)).wait();\n// add delegation pod to\n// 1. make it possible for any user to delegate staking power to\n// the resolver's account\n// 2. make it possible for a resolver to allocate its staking power for itself\nawait (await st1inch.connect(resolver).addPod(delegation.address)).wait();\n\n// register resolver's delegation token to count stakers' shares and rewards\nawait (\n    await delegation\n        .connect(resolver)\n        .functions['register(string,string)'](\n            'MyShareTokenName',\n            'MST',\n        )\n).wait();\n\n// Set default rewards farm\n// Optional, needed to incentivize staker for delegation\nawait (await delegation.connect(resolver).setDefaultFarm(farm.address)).wait();\n\n// Delegate staked power to self\nawait (await delegation.connect(resolver).delegate(resolver.address)).wait();\n\n// Whitelist resolver (there should be enough staked power to be in top 5)\nawait (await whitelist.connect(resolver).register()).wait();\n\n// Add worker address from which order settlement will be executed\nawait (await whitelist.connect(resolver).promote(1, worker.address)).wait();\n")),(0,a.kt)("h3",{id:"1-stake-1inch"},"1. Stake 1inch"),(0,a.kt)("table",null,(0,a.kt)("tr",null,(0,a.kt)("td",null,"Repository"),(0,a.kt)("td",null,(0,a.kt)("a",{href:"https://github.com/1inch/limit-order-settlement/"},"limit-order-settlement"))),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract"),(0,a.kt)("td",null,"st1inch.sol")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract address"),(0,a.kt)("td",null,"0x9A0C8Ff858d273f57072D714bca7411D717501D7")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Methods"),(0,a.kt)("td",null,(0,a.kt)("ul",null,(0,a.kt)("li",null,"deposit(uint256 amount, uint256 duration)"),(0,a.kt)("li",null,"depositWithPermit(uint256 amount, uint256 duration, bytes calldata permit)"),(0,a.kt)("li",null,"depositFor(address account, uint256 amount, uint256 duration)"),(0,a.kt)("li",null,"depositForWithPermit(address account, uint256 amount, uint256 duration, bytes calldata permit)")))),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Description"),(0,a.kt)("td",null,"Stakes 1inch to get staking power according to the lock time"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"//Deposits 100 1inch with 1 day lock\nawait st1inch.deposit(ether('100'), time.duration.days('1'));\n")),(0,a.kt)("h3",{id:"2-register-as-a-resolver"},"2. Register as a Resolver"),(0,a.kt)("h4",{id:"21--register-delegation-pod"},"2.1  Register delegation pod"),(0,a.kt)("table",null,(0,a.kt)("tr",null,(0,a.kt)("td",null,"Repository"),(0,a.kt)("td",null,(0,a.kt)("a",{href:"https://github.com/1inch/limit-order-settlement/"},"limit-order-settlement"))),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract"),(0,a.kt)("td",null,"PowerPod.sol")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract address"),(0,a.kt)("td",null,"0x9A0C8Ff858d273f57072D714bca7411D717501D7")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Methods"),(0,a.kt)("td",null,"addPod(address pod)")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Description"),(0,a.kt)("td",null,"Register pod usage for the tx sender. Needed for",(0,a.kt)("ul",null,(0,a.kt)("li",null,"Resolvers to enable resolver\u2019s and delegated staking power usage for whitelisting"),(0,a.kt)("li",null,"Stakers to enable staking power delegation"))))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"// register `delegation` pod usage a `resolver`\nawait st1inch.connect(resolver).addPod(delegation.address);\n")),(0,a.kt)("h4",{id:"22-register-delegation-share-token"},"2.2. Register delegation share token"),(0,a.kt)("table",null,(0,a.kt)("tr",null,(0,a.kt)("td",null,"Repository"),(0,a.kt)("td",null,(0,a.kt)("a",{href:"https://github.com/1inch/limit-order-settlement/"},"limit-order-settlement"))),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract"),(0,a.kt)("td",null,"st1inch.sol")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract address"),(0,a.kt)("td",null,"0xDAf782667d98d5069eE7ba139932945C4D08fDE9")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Methods"),(0,a.kt)("td",null,"register(string memory name, string memory symbol, uint256 maxUserFarms)")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Description"),(0,a.kt)("td",null,"Creates a resolvers share token to count delegated staked power shares and accrue rewards"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"// Register resolver's token with name 'resolver token share' and symbol 'RTS'\n// allowing the maximum 3 farms running\nawait delegation.register('resolver token share', 'RTS');\n")),(0,a.kt)("h4",{id:"23-set-default-farm"},"2.3. Set default farm"),(0,a.kt)("table",null,(0,a.kt)("tr",null,(0,a.kt)("td",null,"Repository"),(0,a.kt)("td",null,(0,a.kt)("a",{href:"https://github.com/1inch/limit-order-settlement/"},"limit-order-settlement"))),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract"),(0,a.kt)("td",null,"PowerPod.sol")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract address"),(0,a.kt)("td",null,"0xDAf782667d98d5069eE7ba139932945C4D08fDE9")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Methods"),(0,a.kt)("td",null,"setDefaultFarm(address farm)")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Description"),(0,a.kt)("td",null,"Setups the default farm to which all users delegating to this resolver are automatically joined"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"// Setups the default farm to which all users delegating to this resolver\n// are automatically joined\nawait delegation.connect(resolver).setDefaultFarm(farm.address);\n")),(0,a.kt)("h4",{id:"24-delegate-resolvers-staking-power-to-self"},"2.4. Delegate resolver\u2019s staking power to self"),(0,a.kt)("table",null,(0,a.kt)("tr",null,(0,a.kt)("td",null,"Repository"),(0,a.kt)("td",null,(0,a.kt)("a",{href:"https://github.com/1inch/limit-order-settlement/"},"limit-order-settlement"))),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract"),(0,a.kt)("td",null,"PowerPod.sol")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract address"),(0,a.kt)("td",null,"0xDAf782667d98d5069eE7ba139932945C4D08fDE9")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Methods"),(0,a.kt)("td",null,"delegate(address delegatee)")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Description"),(0,a.kt)("td",null,"delegate(address delegatee)"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"// Delegates all staking power to self\nawait delegation.connect(resolver).delegate(resolver.address);\n")),(0,a.kt)("h4",{id:"25-whitelist-resolver"},"2.5. Whitelist resolver"),(0,a.kt)("table",null,(0,a.kt)("tr",null,(0,a.kt)("td",null,"Repository"),(0,a.kt)("td",null,(0,a.kt)("a",{href:"https://github.com/1inch/limit-order-settlement/"},"limit-order-settlement"))),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract"),(0,a.kt)("td",null,"WhitelistRegistry.sol")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract address"),(0,a.kt)("td",null,"0xA49ECb28CC8ab39659be2bFB6F7b86f0c4461A0b")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Methods"),(0,a.kt)("td",null,"register()")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Description"),(0,a.kt)("td",null,"Checks if sender is eligible to be whitelisted and put it into the whitelist sorted by staking power descending"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"// Try to put the sender to the whitelist\nawait whitelist.connect(resolver).register();\n")),(0,a.kt)("h3",{id:"3-feebank"},"3. FeeBank"),(0,a.kt)("table",null,(0,a.kt)("tr",null,(0,a.kt)("td",null,"Repository"),(0,a.kt)("td",null,(0,a.kt)("a",{href:"https://github.com/1inch/limit-order-settlement/"},"limit-order-settlement"))),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract"),(0,a.kt)("td",null,"FeeBank.sol")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract address"),(0,a.kt)("td",null,"0xa0844e046a5B7Db55Bb8DcdFfbF0bBF9c6dc6546")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Methods"),(0,a.kt)("td",null,(0,a.kt)("ul",null,(0,a.kt)("li",null,"deposit(uint256 amount)"),(0,a.kt)("li",null,"depositFor(address account, uint256 amount)"),(0,a.kt)("li",null,"depositWithPermit(uint256 amount, bytes calldata permit)"),(0,a.kt)("li",null,"depositForWithPermit")))),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Description"),(0,a.kt)("td",null,"Deposits 1inch for fee deduction when filling orders"))),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-javascript"},"// Deposit fees to fee bank\nawait feeBank.connect(resolver).deposit(amount)\n")),(0,a.kt)("h3",{id:"resolving-1"},"Resolving"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-Solidity"},"struct Order {\n        uint256 salt;\n        address makerAsset;\n        address takerAsset;\n        address maker;\n        address receiver;\n        address allowedSender;  // equals to Zero address on public orders\n        uint256 makingAmount;\n        uint256 takingAmount;\n        uint256 offsets;\n        // bytes makerAssetData;\n        // bytes takerAssetData;\n        // bytes getMakingAmount; // this.staticcall(abi.encodePacked(bytes, swapTakerAmount)) => (swapMakerAmount)\n        // bytes getTakingAmount; // this.staticcall(abi.encodePacked(bytes, swapMakerAmount)) => (swapTakerAmount)\n        // bytes predicate;       // this.staticcall(bytes) => (bool)\n        // bytes permit;          // On first fill: permit.1.call(abi.encodePacked(permit.selector, permit.2))\n        // bytes preInteraction;\n        // bytes postInteraction;\n        bytes interactions; // concat(makerAssetData, takerAssetData, getMakingAmount, getTakingAmount, predicate, permit, preIntercation, postInteraction)\n    }\n")),(0,a.kt)("table",null,(0,a.kt)("tr",null,(0,a.kt)("td",null,"Repository"),(0,a.kt)("td",null,(0,a.kt)("a",{href:"https://github.com/1inch/limit-order-settlement/"},"limit-order-settlement"))),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract"),(0,a.kt)("td",null,"Settlement.sol")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Contract address"),(0,a.kt)("td",null,"0xA88800CD213dA5Ae406ce248380802BD53b47647")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Methods"),(0,a.kt)("td",null,".settleOrders(bytes calldata data)")),(0,a.kt)("tr",null,(0,a.kt)("td",null,"Description"),(0,a.kt)("td",null,"Settles an order"))))}c.isMDXComponent=!0}}]);